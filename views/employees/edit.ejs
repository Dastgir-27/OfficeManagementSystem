<% layout('layouts/boilerplate') %>


<div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Edit Employee</h1>
        <a href="/employees" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
            Back to Employees
        </a>
    </div>

    <% if (typeof error !== 'undefined') { %>
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <%= error %>
        </div>
    <% } %>

    <form method="POST" action="/employees/<%= employee._id %>?_method=PUT" class="bg-white rounded-lg shadow-md p-6">
        <div class="grid md:grid-cols-2 gap-6">
            <!-- Personal Information -->
            <div class="md:col-span-2">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Personal Information</h3>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                <input type="text" name="firstName" required value="<%= employee.firstName %>"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                <input type="text" name="lastName" required value="<%= employee.lastName %>"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" name="email" required value="<%= employee.email %>"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                <input type="tel" name="phone" value="<%= employee.phone || '' %>"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Work Information -->
            <div class="md:col-span-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Work Information</h3>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Job Title *</label>
                <input type="text" name="jobTitle" required value="<%= employee.jobTitle %>"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Department *</label>
                <select name="department" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Department</option>
                    <% departments.forEach(dept => { %>
                        <option value="<%= dept._id %>" <%= employee.department && employee.department.toString() === dept._id.toString() ? 'selected' : '' %>>
                            <%= dept.name %>
                        </option>
                    <% }) %>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Supervisor</label>
                <select name="supervisor" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">No Supervisor</option>
                    <% supervisors.forEach(supervisor => { %>
                        <option value="<%= supervisor._id %>" <%= employee.supervisor && employee.supervisor.toString() === supervisor._id.toString() ? 'selected' : '' %>>
                            <%= supervisor.firstName %> <%= supervisor.lastName %>
                        </option>
                    <% }) %>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Salary</label>
                <input type="number" name="salary" min="0" step="0.01" value="<%= employee.salary || '' %>"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Hire Date</label>
                <input type="date" name="hireDate" 
                       value="<%= employee.hireDate ? employee.hireDate.toISOString().split('T')[0] : '' %>"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="active" <%= employee.status === 'active' ? 'selected' : '' %>>Active</option>
                    <option value="inactive" <%= employee.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
                    <option value="terminated" <%= employee.status === 'terminated' ? 'selected' : '' %>>Terminated</option>
                </select>
            </div>

            <!-- Location Information -->
            <div class="md:col-span-2 mt-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Location Information</h3>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                <select id="country" name="location[country]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Country</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                <select id="state" name="location[state]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select State</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                <select id="city" name="location[city]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select City</option>
                </select>
            </div>
        </div>

        <div class="mt-6 flex justify-end space-x-3">
            <a href="/employees" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Cancel</a>
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Update Employee
            </button>
        </div>
    </form>
</div>

<script>
$(document).ready(function() {
    const countrySelect = $('#country');
    const stateSelect = $('#state');
    const citySelect = $('#city');
    
    const currentCountry = '<%= employee.location && employee.location.country ? employee.location.country : "" %>';
    const currentState = '<%= employee.location && employee.location.state ? employee.location.state : "" %>';
    const currentCity = '<%= employee.location && employee.location.city ? employee.location.city : "" %>';
    
    // Load countries on page load
    $.get('/api/countries')
        .done(function(countries) {
            countrySelect.empty().append('<option value="">Select Country</option>');
            countries.forEach(function(country) {
                const selected = country.name === currentCountry ? 'selected' : '';
                countrySelect.append(`<option value="${country.name}" ${selected}>${country.name}</option>`);
            });
            
            // Load states if country is selected
            if (currentCountry) {
                loadStates(currentCountry, stateSelect, citySelect, currentState, currentCity);
            }
        });
    
    // Handle country change
    countrySelect.change(function() {
        const country = $(this).val();
        loadStates(country, stateSelect, citySelect);
    });
    
    // Handle state change
    stateSelect.change(function() {
        const country = countrySelect.val();
        const state = $(this).val();
        loadCities(country, state, citySelect);
    });
    
    function loadStates(country, stateSelect, citySelect, selectedState = '', selectedCity = '') {
        if (!country) {
            stateSelect.empty().append('<option value="">Select State</option>');
            citySelect.empty().append('<option value="">Select City</option>');
            return;
        }

        $.get(`/api/states/${encodeURIComponent(country)}`)
            .done(function(states) {
                stateSelect.empty().append('<option value="">Select State</option>');
                citySelect.empty().append('<option value="">Select City</option>');
                states.forEach(function(state) {
                    const selected = state.name === selectedState ? 'selected' : '';
                    stateSelect.append(`<option value="${state.name}" ${selected}>${state.name}</option>`);
                });
                
                // Load cities if state is selected
                if (selectedState) {
                    loadCities(country, selectedState, citySelect, selectedCity);
                }
            });
    }
    
    function loadCities(country, state, citySelect, selectedCity = '') {
        if (!country || !state) {
            citySelect.empty().append('<option value="">Select City</option>');
            return;
        }

        $.get(`/api/cities/${encodeURIComponent(country)}/${encodeURIComponent(state)}`)
            .done(function(cities) {
                citySelect.empty().append('<option value="">Select City</option>');
                cities.forEach(function(city) {
                    const selected = city === selectedCity ? 'selected' : '';
                    citySelect.append(`<option value="${city}" ${selected}>${city}</option>`);
                });
            });
    }
});
</script>
                    